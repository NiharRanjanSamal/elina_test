<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.23.xsd">

    <!-- Create task_updates table -->
    <changeSet id="019-create-task-updates-table" author="projects-module">
        <createTable tableName="task_updates">
            <column name="update_id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_task_updates_tenant" references="tenants(id)"/>
            </column>
            <column name="task_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_task_updates_task" references="tasks(task_id)"/>
            </column>
            <column name="update_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="planned_qty" type="DECIMAL(18,2)"/>
            <column name="actual_qty" type="DECIMAL(18,2)" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="daily_update_qty" type="DECIMAL(18,2)"/>
            <column name="remarks" type="VARCHAR(1000)"/>
            <column name="activate_flag" type="BIT" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="BIGINT"/>
            <column name="created_on" type="DATETIME2" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_by" type="BIGINT"/>
            <column name="updated_on" type="DATETIME2"/>
        </createTable>

        <!-- Unique constraint: tenant_id, task_id, update_date -->
        <addUniqueConstraint
                tableName="task_updates"
                columnNames="tenant_id,task_id,update_date"
                constraintName="UQ_task_updates_tenant_task_date"/>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_task_updates_tenant_id" tableName="task_updates">
            <column name="tenant_id"/>
        </createIndex>

        <createIndex indexName="idx_task_updates_task_id" tableName="task_updates">
            <column name="tenant_id"/>
            <column name="task_id"/>
        </createIndex>

        <createIndex indexName="idx_task_updates_date" tableName="task_updates" unique="true">
            <column name="tenant_id"/>
            <column name="task_id"/>
            <column name="update_date"/>
        </createIndex>

        <createIndex indexName="idx_task_updates_tenant_active" tableName="task_updates">
            <column name="tenant_id"/>
            <column name="activate_flag"/>
        </createIndex>
    </changeSet>

    <!-- Create confirmations table -->
    <changeSet id="019-create-confirmations-table" author="projects-module">
        <createTable tableName="confirmations">
            <column name="confirmation_id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_confirmations_tenant" references="tenants(id)"/>
            </column>
            <column name="entity_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="confirmation_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="confirmed_by" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="confirmed_on" type="DATETIME2" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="remarks" type="VARCHAR(1000)"/>
            <column name="created_by" type="BIGINT"/>
            <column name="created_on" type="DATETIME2" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_confirmations_tenant_id" tableName="confirmations">
            <column name="tenant_id"/>
        </createIndex>

        <createIndex indexName="idx_confirmations_entity" tableName="confirmations">
            <column name="tenant_id"/>
            <column name="entity_type"/>
            <column name="entity_id"/>
        </createIndex>

        <createIndex indexName="idx_confirmations_date" tableName="confirmations">
            <column name="tenant_id"/>
            <column name="confirmation_date"/>
        </createIndex>
    </changeSet>

    <!-- Create audit_logs table -->
    <changeSet id="019-create-audit-logs-table" author="projects-module">
        <createTable tableName="audit_logs">
            <column name="audit_id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_audit_logs_tenant" references="tenants(id)"/>
            </column>
            <column name="table_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="record_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="action_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="old_data" type="NVARCHAR(MAX)"/>
            <column name="new_data" type="NVARCHAR(MAX)"/>
            <column name="changed_by" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="changed_on" type="DATETIME2" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes for performance -->
        <createIndex indexName="idx_audit_logs_tenant_id" tableName="audit_logs">
            <column name="tenant_id"/>
        </createIndex>

        <createIndex indexName="idx_audit_logs_table_record" tableName="audit_logs">
            <column name="tenant_id"/>
            <column name="table_name"/>
            <column name="record_id"/>
        </createIndex>

        <createIndex indexName="idx_audit_logs_changed_on" tableName="audit_logs">
            <column name="tenant_id"/>
            <column name="changed_on"/>
        </createIndex>

        <createIndex indexName="idx_audit_logs_changed_by" tableName="audit_logs">
            <column name="tenant_id"/>
            <column name="changed_by"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>

